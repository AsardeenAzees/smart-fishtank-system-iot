<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Smart Fish Tank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #0ea5e9;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --border: #1f2a44;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      background: var(--bg);
      color: var(--text)
    }

    header {
      padding: 18px 18px 0
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      font-weight: 700
    }

    .sub {
      color: var(--muted);
      font-size: 13px
    }

    main {
      padding: 18px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      align-items: start
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px #0006
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 18px
    }

    .k {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      font-size: 14px
    }

    .k b {
      font-variant-numeric: tabular-nums
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 8px 0
    }

    .btn {
      padding: 9px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0b213a;
      color: #e8f2ff;
      cursor: pointer;
      transition: transform .04s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease, color .15s ease;
      user-select: none;
      touch-action: manipulation
    }

    .btn:hover {
      background: #0e2948
    }

    .btn:active {
      transform: translateY(1px)
    }

    .btn.ok {
      background: #0f3a2e;
      border-color: #1a5847
    }

    .btn.warn {
      background: #3a2f0f;
      border-color: #5a4a1a
    }

    .btn.bad {
      background: #3a1212;
      border-color: #5a1a1a
    }

    .btn.ghost {
      background: transparent;
      color: var(--muted)
    }

    .btn[disabled] {
      opacity: .45;
      cursor: not-allowed;
      filter: grayscale(.15)
    }

    /* ACTIVE STATE HIGHLIGHT */
    .btn.active {
      background: #122e4f;
      border-color: #2b86c9;
      box-shadow: 0 0 0 2px #2b86c955 inset, 0 0 24px #0ea5e955;
      color: #e6f3ff;
    }

    .btn.ok.active {
      background: #134136;
      border-color: #2ea585;
      box-shadow: 0 0 0 2px #2ea58555 inset, 0 0 24px #2ea58555
    }

    .btn.warn.active {
      background: #43330f;
      border-color: #d7a125;
      box-shadow: 0 0 0 2px #d7a12555 inset, 0 0 24px #d7a12555
    }

    .btn.bad.active {
      background: #451515;
      border-color: #ef4444;
      box-shadow: 0 0 0 2px #ef444455 inset, 0 0 24px #ef444455
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b213a;
      color: #e8f2ff
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin: 10px 0 6px
    }

    small {
      color: var(--muted)
    }

    .tag {
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted)
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #0b213a;
      border: 1px solid var(--border);
      font-size: 12px
    }

    .grid2 {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(2, 1fr)
    }

    hr {
      border: none;
      height: 1px;
      background: var(--border);
      margin: 12px 0
    }

    footer {
      padding: 0 18px 18px;
      color: var(--muted);
      font-size: 12px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
    }

    .muted {
      color: var(--muted)
    }
  </style>
</head>

<body>
  <header>
    <h1>üêü Smart Fish Tank</h1>
    <div class="sub">Live control dashboard (ESP32 + Firebase RTDB)</div>
  </header>

  <main>
    <!-- Sensors -->
    <section class="card">
      <h2>Live Sensors</h2>
      <div class="k"><span>Temperature</span><b><span id="tC">‚Äî</span> ¬∞C</b></div>
      <div class="k"><span>Humidity</span><b><span id="hum">‚Äî</span> %</b></div>
      <div class="k"><span>Proximity</span><b><span id="prox">‚Äî</span> cm</b></div>
      <div class="k"><span>Light ADC</span><b><span id="ldr">‚Äî</span></b></div>
      <div class="k"><span>Water ADC</span><b><span id="water">‚Äî</span></b></div>
      <hr />
      <div class="k"><span class="muted">Updated</span><small id="updated">‚Äî</small></div>
    </section>

    <!-- States -->
    <section class="card">
      <h2>Device States</h2>
      <div class="k"><span>Light</span><b id="lightState" class="pill">‚Äî</b></div>
      <div class="k"><span>Pump</span><b id="pumpState" class="pill">‚Äî</b></div>
      <div class="k"><span>Buzzer</span><b id="buzzState" class="pill">‚Äî</b></div>
      <hr />
      <div class="k"><span>Light Mode</span><b id="lightMode" class="tag">‚Äî</b></div>
      <div class="k"><span>Pump Mode</span><b id="pumpMode" class="tag">‚Äî</b></div>
      <div class="k"><span>Buzzer Mode</span><b id="buzzerMode" class="tag">‚Äî</b></div>
    </section>

    <!-- Controls -->
    <section class="card">
      <h2>Controls</h2>
      <!-- Light mode -->
      <div class="row">
        <button id="lightAuto" class="btn" aria-pressed="false">Light: AUTO</button>
        <button id="lightManual" class="btn" aria-pressed="false">MANUAL</button>
        <button id="lightOff" class="btn" aria-pressed="false">OFF</button>
      </div>
      <!-- Light manual toggle -->
      <div class="row">
        <button id="lightOn" class="btn ok" aria-pressed="false">Light ON</button>
        <button id="lightOff2" class="btn" aria-pressed="false">Light OFF</button>
      </div>

      <hr />

      <!-- Pump mode -->
      <div class="row">
        <button id="pumpAuto" class="btn" aria-pressed="false">Pump: AUTO</button>
        <button id="pumpManual" class="btn" aria-pressed="false">MANUAL</button>
        <button id="pumpOff" class="btn" aria-pressed="false">OFF</button>
      </div>
      <!-- Pump manual toggle -->
      <div class="row">
        <button id="pumpOn" class="btn ok" aria-pressed="false">Pump ON</button>
        <button id="pumpOff2" class="btn" aria-pressed="false">Pump OFF</button>
      </div>

      <hr />

      <!-- Buzzer mode -->
      <div class="row">
        <button id="buzzFeedOnly" class="btn warn" aria-pressed="false">Buzzer: Feed-Only</button>
        <button id="buzzNormal" class="btn" aria-pressed="false">Buzzer: Normal</button>
      </div>
      <!-- Legacy buzzer cmds -->
      <div class="row">
        <button id="buzzToggle" class="btn">Buzzer Toggle</button>
        <input id="buzzSilenceMin" type="number" min="1" placeholder="Silence minutes" />
        <button id="buzzSilenceBtn" class="btn">Silence</button>
      </div>

      <div class="row">
        <button id="feedNow" class="btn ok">Feed Now</button>
      </div>
    </section>

    <!-- Settings -->
    <section class="card">
      <h2>Automation Settings</h2>
      <div class="grid2">
        <div>
          <label>Proximity threshold (cm)</label>
          <input id="thrProx" type="number" value="20" />
        </div>
        <div>
          <label>Low light ADC</label>
          <input id="thrLdr" type="number" value="1700" />
        </div>
        <div>
          <label>Water low ADC</label>
          <input id="thrWater" type="number" value="1200" />
        </div>
        <div>
          <label>High temp (¬∞C)</label>
          <input id="thrTemp" type="number" step="0.1" value="32" />
        </div>
        <div>
          <label>Hourly pump seconds</label>
          <input id="hourlySecs" type="number" value="25" />
        </div>
      </div>
      <div class="row">
        <button id="saveSettings" class="btn">Save Settings</button>
      </div>
      <hr />
      <h2>Feeding</h2>
      <div class="grid2">
        <div>
          <label>Feeding time 1 (HH:MM)</label>
          <input id="feed1" type="text" value="08:00" placeholder="08:00" />
        </div>
        <div>
          <label>Feeding time 2 (HH:MM)</label>
          <input id="feed2" type="text" value="20:00" placeholder="20:00" />
        </div>
      </div>
      <div class="row">
        <button id="saveFeeding" class="btn">Save Feeding</button>
      </div>
      <hr />
      <div class="k"><span>Last feed</span><b id="lastFeed">‚Äî</b></div>
      <div class="k"><span>Label</span><b id="lastFeedLabel" class="tag">‚Äî</b></div>
    </section>

    <!-- Logs (today) -->
    <section class="card">
      <h2>Recent Logs (today)</h2>
      <div class="row">
        <button id="refreshLogs" class="btn">Refresh</button>
        <small class="muted">Shows last ~30 entries for today</small>
      </div>
      <div id="logs" class="mono" style="font-size:12px; max-height:260px; overflow:auto; white-space:pre;"></div>
    </section>
  </main>

  <footer>
    <span class="muted">Signed in as:</span> <span id="uid" class="mono">‚Äî</span>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, set, get } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";

    // ====== REPLACE WITH YOUR PROJECT CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyCPokWLKrM-JbJgQL0vVDccdR-qrmAHQ_Q",
      authDomain: "fishtank-system.firebaseapp.com",
      databaseURL: "https://fishtank-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fishtank-system",
      storageBucket: "fishtank-system.firebasestorage.app",
      messagingSenderId: "333858962529",
      appId: "1:333858962529:web:87ea50878e00d4bdd8be20",
      measurementId: "G-67L85BD3S8"
    };
    // =============================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Auth
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (u) => { if (u) { document.getElementById('uid').textContent = u.uid; } });

    // Helpers
    const $ = (id) => document.getElementById(id);
    const asTime = (s) => s ? new Date(s * 1000).toLocaleString() : "‚Äî";
    const setPill = (el, on) => { el.textContent = on ? "ON" : "OFF"; el.style.borderColor = on ? "#1a5847" : "var(--border)"; };
    const setDisabled = (ids, dis) => ids.forEach(id => {
      const el = $(id); if (!el) return;
      el.disabled = dis;
      el.classList.toggle('ghost', dis);
      el.setAttribute('aria-pressed', el.classList.contains('active') && !dis ? 'true' : 'false');
      if (dis) el.classList.remove('active'); // when disabled, ensure not highlighted
    });
    const markActiveOne = (ids, activeId) => ids.forEach(id => {
      const el = $(id); if (!el) return;
      const on = (id === activeId);
      el.classList.toggle('active', on);
      el.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
    const clearActive = (ids) => ids.forEach(id => { const el = $(id); if (el) { el.classList.remove('active'); el.setAttribute('aria-pressed', 'false'); } });

    // Live sensors
    onValue(ref(db, '/sensors'), snap => {
      const v = snap.val() || {};
      $('tC').textContent = v.temperature_c ?? '‚Äî';
      $('hum').textContent = v.humidity_pct ?? '‚Äî';
      $('prox').textContent = v.proximity_cm ?? '‚Äî';
      $('ldr').textContent = v.light_adc ?? '‚Äî';
      $('water').textContent = v.water_adc ?? '‚Äî';
      $('updated').textContent = asTime(v.last_update);
    });

    // Live states + ACTIVE BUTTON SYNC
    onValue(ref(db, '/states'), snap => {
      const v = snap.val() || {};

      // pills
      setPill($('lightState'), !!v.light_on);
      setPill($('pumpState'), !!v.pump_on);
      setPill($('buzzState'), !!v.buzzer_on);

      // text tags
      const lm = (v.light_mode || 'auto');
      const pm = (v.pump_mode || 'auto');
      const bm = (v.buzzer_mode || 'normal');
      $('lightMode').textContent = lm;
      $('pumpMode').textContent = pm;
      $('buzzerMode').textContent = bm;

      // highlight Light mode buttons
      const lightModeBtn = { auto: 'lightAuto', manual: 'lightManual', off: 'lightOff' }[lm] || 'lightAuto';
      markActiveOne(['lightAuto', 'lightManual', 'lightOff'], lightModeBtn);

      // highlight Pump mode buttons
      const pumpModeBtn = { auto: 'pumpAuto', manual: 'pumpManual', off: 'pumpOff' }[pm] || 'pumpAuto';
      markActiveOne(['pumpAuto', 'pumpManual', 'pumpOff'], pumpModeBtn);

      // highlight Buzzer mode buttons
      const buzBtn = (bm === 'feed_only') ? 'buzzFeedOnly' : 'buzzNormal';
      markActiveOne(['buzzFeedOnly', 'buzzNormal'], buzBtn);

      // enable/disable + highlight manual ON/OFF based on mode
      setDisabled(['lightOn', 'lightOff2'], lm !== 'manual');
      setDisabled(['pumpOn', 'pumpOff2'], pm !== 'manual');

      if (lm === 'manual') {
        markActiveOne(['lightOn', 'lightOff2'], v.light_on ? 'lightOn' : 'lightOff2');
      } else {
        clearActive(['lightOn', 'lightOff2']);
      }

      if (pm === 'manual') {
        markActiveOne(['pumpOn', 'pumpOff2'], v.pump_on ? 'pumpOn' : 'pumpOff2');
      } else {
        clearActive(['pumpOn', 'pumpOff2']);
      }
    });

    // Settings live load
    onValue(ref(db, '/settings'), snap => {
      const s = snap.val() || {};
      if (s.thresholds) {
        if (s.thresholds.proximity_cm != null) $('thrProx').value = s.thresholds.proximity_cm;
        if (s.thresholds.low_light_adc != null) $('thrLdr').value = s.thresholds.low_light_adc;
        if (s.thresholds.water_low_adc != null) $('thrWater').value = s.thresholds.water_low_adc;
        if (s.thresholds.high_temp_c != null) $('thrTemp').value = s.thresholds.high_temp_c;
      }
      if (s.hourly_pump && s.hourly_pump.seconds != null) $('hourlySecs').value = s.hourly_pump.seconds;
      if (s.feeding) {
        if (s.feeding.time1) $('feed1').value = s.feeding.time1;
        if (s.feeding.time2) $('feed2').value = s.feeding.time2;
      }
    });

    // Feeding meta
    onValue(ref(db, '/meta'), snap => {
      const m = snap.val() || {};
      $('lastFeed').textContent = m.last_feed_time ? new Date(m.last_feed_time * 1000).toLocaleString() : '‚Äî';
      $('lastFeedLabel').textContent = m.last_feed_label || '‚Äî';
    });

    // Controls ‚Üí /commands
    const cmdRef = ref(db, '/commands');

    // Light mode
    $('lightAuto').onclick = () => update(cmdRef, { light_mode: 'auto' });
    $('lightManual').onclick = () => update(cmdRef, { light_mode: 'manual' });
    $('lightOff').onclick = () => update(cmdRef, { light_mode: 'off' });
    // Light manual state
    $('lightOn').onclick = () => update(cmdRef, { light_manual_state: true });
    $('lightOff2').onclick = () => update(cmdRef, { light_manual_state: false });

    // Pump mode
    $('pumpAuto').onclick = () => update(cmdRef, { pump_mode: 'auto' });
    $('pumpManual').onclick = () => update(cmdRef, { pump_mode: 'manual' });
    $('pumpOff').onclick = () => update(cmdRef, { pump_mode: 'off' });
    // Pump manual state
    $('pumpOn').onclick = () => update(cmdRef, { pump_manual_state: true });
    $('pumpOff2').onclick = () => update(cmdRef, { pump_manual_state: false });

    // Buzzer mode
    $('buzzFeedOnly').onclick = () => update(cmdRef, { buzzer_mode: 'feed_only' });
    $('buzzNormal').onclick = () => update(cmdRef, { buzzer_mode: 'normal' });

    // Legacy buzzer controls
    $('buzzToggle').onclick = () => update(cmdRef, { buzzer_toggle: true });
    $('buzzSilenceBtn').onclick = () => {
      const mins = parseInt($('buzzSilenceMin').value || "0", 10);
      if (mins > 0) update(cmdRef, { buzzer_silence_minutes: mins });
    };

    // Feed Now
    $('feedNow').onclick = () => update(cmdRef, { feed_now: true });

    // Save settings
    $('saveSettings').onclick = () => {
      const up = {
        thresholds: {
          proximity_cm: parseInt($('thrProx').value || "20", 10),
          low_light_adc: parseInt($('thrLdr').value || "1700", 10),
          water_low_adc: parseInt($('thrWater').value || "1200", 10),
          high_temp_c: parseFloat($('thrTemp').value || "32")
        },
        hourly_pump: { seconds: parseInt($('hourlySecs').value || "25", 10) }
      };
      update(ref(db, '/settings'), up);
    };

    $('saveFeeding').onclick = () => {
      const up = { feeding: { time1: $('feed1').value, time2: $('feed2').value } };
      update(ref(db, '/settings'), up);
    };

    // Logs (today)
    function ymd(d) {
      const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), dd = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    }
    async function loadLogs() {
      const today = ymd(new Date());
      const base = `/logs/sensors/${today}`;
      const snap = await get(ref(db, base));
      const val = snap.val() || {};
      const keys = Object.keys(val).sort(); // timestamps asc
      const last = keys.slice(-30);
      const lines = last.map(k => {
        const v = val[k];
        return `${new Date(parseInt(k, 10) * 1000).toLocaleTimeString()}  tC=${v.tC}  h=${v.h}  ldr=${v.ldr}  water=${v.water}  prox=${v.prox_cm}`;
      });
      $('logs').textContent = lines.join('\n') || 'No entries yet.';
    }
    $('refreshLogs').onclick = loadLogs;
    loadLogs();
  </script>
</body>

</html>