<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Smart Fish Tank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root {
      --bg: #0b1220;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #0ea5e9;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --border: #1f2a44;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      background: var(--bg);
      color: var(--text)
    }

    header {
      padding: 18px 18px 0
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      font-weight: 700
    }

    .sub {
      color: var(--muted);
      font-size: 13px
    }

    main {
      padding: 18px;
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      align-items: start
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 10px 30px #00000040
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 18px
    }

    .k {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      font-size: 14px
    }

    .k b {
      font-variant-numeric: tabular-nums
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 8px 0
    }

    .btn {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0b213a;
      color: #e8f2ff;
      cursor: pointer
    }

    .btn:hover {
      background: #0d2a49
    }

    .btn.ok {
      background: #0f3a2e;
      border-color: #1a5847
    }

    .btn.warn {
      background: #3a2f0f;
      border-color: #5a4a1a
    }

    .btn.bad {
      background: #3a1212;
      border-color: #5a1a1a
    }

    .btn.ghost {
      background: transparent
    }

    .switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted)
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b213a;
      color: #e8f2ff
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin: 10px 0 6px
    }

    small {
      color: var(--muted)
    }

    .tag {
      padding: 3px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted)
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #0b213a;
      border: 1px solid var(--border);
      font-size: 12px
    }

    .grid2 {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(2, 1fr)
    }

    hr {
      border: none;
      height: 1px;
      background: var(--border);
      margin: 12px 0
    }

    footer {
      padding: 0 18px 18px;
      color: var(--muted);
      font-size: 12px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace
    }

    .muted {
      color: var(--muted)
    }

    .danger {
      color: var(--bad)
    }
  </style>
</head>

<body>
  <header>
    <h1>üêü Smart Fish Tank</h1>
    <div class="sub">Live control dashboard (ESP32 + Firebase RTDB)</div>
  </header>

  <main>
    <!-- Sensors -->
    <section class="card">
      <h2>Live Sensors</h2>
      <div class="k"><span>Temperature</span><b><span id="tC">‚Äî</span> ¬∞C</b></div>
      <div class="k"><span>Humidity</span><b><span id="hum">‚Äî</span> %</b></div>
      <div class="k"><span>Proximity</span><b><span id="prox">‚Äî</span> cm</b></div>
      <div class="k"><span>Light ADC</span><b><span id="ldr">‚Äî</span></b></div>
      <div class="k"><span>Water ADC</span><b><span id="water">‚Äî</span></b></div>
      <hr />
      <div class="k"><span class="muted">Updated</span><small id="updated">‚Äî</small></div>
    </section>

    <!-- States -->
    <section class="card">
      <h2>Device States</h2>
      <div class="k"><span>Light</span><b id="lightState" class="pill">‚Äî</b></div>
      <div class="k"><span>Pump</span><b id="pumpState" class="pill">‚Äî</b></div>
      <div class="k"><span>Buzzer</span><b id="buzzState" class="pill">‚Äî</b></div>
      <hr />
      <div class="k"><span>Light Mode</span><b id="lightMode" class="tag">‚Äî</b></div>
      <div class="k"><span>Pump Mode</span><b id="pumpMode" class="tag">‚Äî</b></div>
    </section>

    <!-- Controls -->
    <section class="card">
      <h2>Controls</h2>
      <div class="row">
        <button id="lightAuto" class="btn">Light: AUTO</button>
        <button id="lightManual" class="btn">MANUAL</button>
        <button id="lightOff" class="btn">OFF</button>
      </div>
      <div class="row">
        <button id="lightOn" class="btn ok">Light ON</button>
        <button id="lightOff2" class="btn">Light OFF</button>
      </div>
      <hr />
      <div class="row">
        <button id="pumpAuto" class="btn">Pump: AUTO</button>
        <button id="pumpManual" class="btn">MANUAL</button>
        <button id="pumpOff" class="btn">OFF</button>
      </div>
      <div class="row">
        <button id="pumpOn" class="btn ok">Pump ON</button>
        <button id="pumpOff2" class="btn">Pump OFF</button>
      </div>
      <hr />
      <div class="row">
        <button id="buzzToggle" class="btn warn">Buzzer Toggle</button>
        <input id="buzzSilenceMin" type="number" min="1" placeholder="Silence minutes" />
        <button id="buzzSilenceBtn" class="btn">Silence</button>
      </div>
      <div class="row">
        <button id="feedNow" class="btn ok">Feed Now</button>
      </div>
    </section>

    <!-- Settings -->
    <section class="card">
      <h2>Automation Settings</h2>
      <div class="grid2">
        <div>
          <label>Proximity threshold (cm)</label>
          <input id="thrProx" type="number" value="20" />
        </div>
        <div>
          <label>Low light ADC</label>
          <input id="thrLdr" type="number" value="1700" />
        </div>
        <div>
          <label>Water low ADC</label>
          <input id="thrWater" type="number" value="1200" />
        </div>
        <div>
          <label>High temp (¬∞C)</label>
          <input id="thrTemp" type="number" step="0.1" value="32" />
        </div>
        <div>
          <label>Hourly pump seconds</label>
          <input id="hourlySecs" type="number" value="25" />
        </div>
      </div>
      <div class="row">
        <button id="saveSettings" class="btn">Save Settings</button>
      </div>
      <hr />
      <h2>Feeding</h2>
      <div class="grid2">
        <div>
          <label>Feeding time 1 (HH:MM)</label>
          <input id="feed1" type="text" value="08:00" placeholder="08:00" />
        </div>
        <div>
          <label>Feeding time 2 (HH:MM)</label>
          <input id="feed2" type="text" value="20:00" placeholder="20:00" />
        </div>
      </div>
      <div class="row">
        <button id="saveFeeding" class="btn">Save Feeding</button>
      </div>
      <hr />
      <div class="k"><span>Last feed</span><b id="lastFeed">‚Äî</b></div>
      <div class="k"><span>Label</span><b id="lastFeedLabel" class="tag">‚Äî</b></div>
    </section>

    <!-- Logs (today) -->
    <section class="card">
      <h2>Recent Logs (today)</h2>
      <div class="row">
        <button id="refreshLogs" class="btn">Refresh</button>
        <small class="muted">Shows last ~30 entries for today</small>
      </div>
      <div id="logs" class="mono" style="font-size:12px; max-height:260px; overflow:auto; white-space:pre;"></div>
    </section>
  </main>

  <footer>
    <span class="muted">Signed in as:</span> <span id="uid" class="mono">‚Äî</span>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, set, get, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js";

    // ==== 1) REPLACE WITH YOUR PROJECT CONFIG ====
    const firebaseConfig = {
      apiKey: "AIzaSyCPokWLKrM-JbJgQL0vVDccdR-qrmAHQ_Q",
      authDomain: "fishtank-system.firebaseapp.com",
      databaseURL: "https://fishtank-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fishtank-system",
      storageBucket: "fishtank-system.firebasestorage.app",
      messagingSenderId: "333858962529",
      appId: "1:333858962529:web:87ea50878e00d4bdd8be20",
      measurementId: "G-67L85BD3S8"
    };
    // ============================================

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Auth
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (u) => { if (u) { document.getElementById('uid').textContent = u.uid; } });

    // Helpers
    const $ = id => document.getElementById(id);
    const asTime = (s) => s ? new Date(s * 1000).toLocaleString() : "‚Äî";
    const setPill = (el, on) => { el.textContent = on ? "ON" : "OFF"; el.style.borderColor = on ? "#1a5847" : "var(--border)" }

    // Live sensors
    onValue(ref(db, '/sensors'), snap => {
      const v = snap.val() || {};
      $('tC').textContent = v.temperature_c ?? '‚Äî';
      $('hum').textContent = v.humidity_pct ?? '‚Äî';
      $('prox').textContent = v.proximity_cm ?? '‚Äî';
      $('ldr').textContent = v.light_adc ?? '‚Äî';
      $('water').textContent = v.water_adc ?? '‚Äî';
      $('updated').textContent = asTime(v.last_update);
    });

    // Live states
    onValue(ref(db, '/states'), snap => {
      const v = snap.val() || {};
      setPill($('lightState'), !!v.light_on);
      setPill($('pumpState'), !!v.pump_on);
      setPill($('buzzState'), !!v.buzzer_on);
      $('lightMode').textContent = v.light_mode || 'auto';
      $('pumpMode').textContent = v.pump_mode || 'auto';

      // Enable/disable manual buttons depending on mode
      const lm = (v.light_mode || 'auto');
      const pm = (v.pump_mode || 'auto');
      const setDis = (ids, dis) => ids.forEach(id => { $(id).disabled = dis; $(id).classList.toggle('ghost', dis); });
      setDis(['lightOn', 'lightOff2'], lm !== 'manual');
      setDis(['pumpOn', 'pumpOff2'], pm !== 'manual');
    });

    // Settings live load
    onValue(ref(db, '/settings'), snap => {
      const s = snap.val() || {};
      if (s.thresholds) {
        if (s.thresholds.proximity_cm != null) $('thrProx').value = s.thresholds.proximity_cm;
        if (s.thresholds.low_light_adc != null) $('thrLdr').value = s.thresholds.low_light_adc;
        if (s.thresholds.water_low_adc != null) $('thrWater').value = s.thresholds.water_low_adc;
        if (s.thresholds.high_temp_c != null) $('thrTemp').value = s.thresholds.high_temp_c;
      }
      if (s.hourly_pump && s.hourly_pump.seconds != null) $('hourlySecs').value = s.hourly_pump.seconds;
      if (s.feeding) {
        if (s.feeding.time1) $('feed1').value = s.feeding.time1;
        if (s.feeding.time2) $('feed2').value = s.feeding.time2;
      }
    });

    // Feeding meta
    onValue(ref(db, '/meta'), snap => {
      const m = snap.val() || {};
      $('lastFeed').textContent = m.last_feed_time ? new Date(m.last_feed_time * 1000).toLocaleString() : '‚Äî';
      $('lastFeedLabel').textContent = m.last_feed_label || '‚Äî';
    });

    // Controls ‚Üí /commands
    const cmdRef = ref(db, '/commands');

    $('lightAuto').onclick = () => update(cmdRef, { light_mode: 'auto' });
    $('lightManual').onclick = () => update(cmdRef, { light_mode: 'manual' });
    $('lightOff').onclick = () => update(cmdRef, { light_mode: 'off' });
    $('lightOn').onclick = () => update(cmdRef, { light_manual_state: true });
    $('lightOff2').onclick = () => update(cmdRef, { light_manual_state: false });

    $('pumpAuto').onclick = () => update(cmdRef, { pump_mode: 'auto' });
    $('pumpManual').onclick = () => update(cmdRef, { pump_mode: 'manual' });
    $('pumpOff').onclick = () => update(cmdRef, { pump_mode: 'off' });
    $('pumpOn').onclick = () => update(cmdRef, { pump_manual_state: true });
    $('pumpOff2').onclick = () => update(cmdRef, { pump_manual_state: false });

    $('buzzToggle').onclick = () => update(cmdRef, { buzzer_toggle: true });
    $('buzzSilenceBtn').onclick = () => {
      const mins = parseInt($('buzzSilenceMin').value || "0", 10);
      if (mins > 0) update(cmdRef, { buzzer_silence_minutes: mins });
    };

    $('feedNow').onclick = () => update(cmdRef, { feed_now: true });

    // Save settings
    $('saveSettings').onclick = () => {
      update(ref(db, '/settings'), {
        thresholds: {
          proximity_cm: parseInt($('thrProx').value, 10),
          low_light_adc: parseInt($('thrLdr').value, 10),
          water_low_adc: parseInt($('thrWater').value, 10),
          high_temp_c: parseFloat($('thrTemp').value)
        },
        hourly_pump: { seconds: parseInt($('hourlySecs').value, 10) }
      });
      alert('Settings saved');
    };

    $('saveFeeding').onclick = () => {
      update(ref(db, '/settings/feeding'), {
        time1: $('feed1').value.trim(),
        time2: $('feed2').value.trim()
      });
      alert('Feeding times saved');
    };

    // Logs (today)
    function ymd(d) {
      const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), dd = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    }
    async function loadLogs() {
      const today = ymd(new Date());
      const base = `/logs/sensors/${today}`;
      // We can't orderByKey & limit reliably on RTDB subtrees with unknown keys via REST here,
      // but we can read the node once and then slice last N entries.
      const snap = await get(ref(db, base));
      const val = snap.val() || {};
      const keys = Object.keys(val).sort(); // timestamps ascending
      const last = keys.slice(-30); // last ~30 entries
      const lines = last.map(k => {
        const v = val[k];
        return `${new Date(parseInt(k, 10) * 1000).toLocaleTimeString()}  tC=${v.tC}  h=${v.h}  ldr=${v.ldr}  water=${v.water}  prox=${v.prox_cm}`;
      });
      $('logs').textContent = lines.join('\n') || 'No entries yet.';
    }
    $('refreshLogs').onclick = loadLogs;
    loadLogs();
  </script>
</body>

</html>