<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Smart Fish Tank Dashboard</title>

  <!-- Firebase (Compat for simplicity with your firmware) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg: #0b1020;
      --card: #121831;
      --muted: #8ba0d9;
      --text: #eaf0ff;
      --accent: #5b8cff;
      --on: #11b57f;
      --off: #cf3e59;
      --warn: #ffb020;
      --border: #223059;
      --chip: #1a2244;
      --chip-border: #2a3a66;
      --shadow: 0 10px 30px rgba(0, 0, 0, .28);
      --radius: 16px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font: 500 clamp(14px, 1.8vw, 16px)/1.5 Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap {
      max-width: 1100px;
      margin: max(12px, env(safe-area-inset-top)) auto env(safe-area-inset-bottom) auto;
      padding: 0 clamp(10px, 3vw, 16px);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 86%, transparent);
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      margin: -12px calc(clamp(10px, 3vw, 16px) * -1) 14px;
      padding: 10px clamp(10px, 3vw, 16px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .brand h1 {
      margin: 0;
      font-size: clamp(18px, 3.2vw, 22px);
      letter-spacing: .2px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--chip);
      color: var(--muted);
      border: 1px solid var(--chip-border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, 1fr)
    }

    .card {
      grid-column: span 12;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #dbe6ff
    }

    /* Sensor chips */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px
    }

    .kv {
      min-width: 140px;
      flex: 1 1 140px;
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .kv b {
      display: block;
      font-size: 12px;
      color: var(--muted)
    }

    .kv span {
      display: block;
      font-size: 18px;
      margin-top: 2px
    }

    /* Buttons */
    button {
      font: inherit;
      color: inherit;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      transition: transform .05s ease, border-color .2s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
      min-height: 44px;
      padding: 10px 14px;
    }

    .btn {
      background: #0e1530;
      border: 1px solid var(--border)
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: #3a58a1
    }

    .btn:active {
      transform: translateY(0)
    }

    .btn.primary {
      background: var(--accent);
      border-color: #3655c9;
      color: #fff
    }

    .btn.ghost {
      background: transparent
    }

    .btn.warn {
      background: var(--warn);
      border-color: #a77500;
      color: #1a1a1a
    }

    /* Manual ON/OFF highlight */
    .toggle {
      background: linear-gradient(180deg, #0f1530 0%, #0b1026 100%);
      border: 1px solid var(--border)
    }

    .toggle.active {
      background: linear-gradient(180deg, rgba(17, 181, 127, .18) 0%, rgba(17, 181, 127, .08) 100%);
      border-color: rgba(17, 181, 127, .6);
      color: #eafff6;
      box-shadow: 0 0 0 2px rgba(17, 181, 127, .15) inset;
    }

    .toggle.off {
      background: linear-gradient(180deg, rgba(207, 62, 89, .16) 0%, rgba(207, 62, 89, .08) 100%);
      border-color: rgba(207, 62, 89, .55);
      color: #ffd8df;
      box-shadow: 0 0 0 2px rgba(207, 62, 89, .12) inset;
    }

    /* Mode segmented control */
    .seg {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden
    }

    .seg button {
      background: transparent;
      border: 0;
      color: var(--muted);
      padding: 10px 12px;
      font-weight: 700;
      min-width: 84px
    }

    .seg button+button {
      border-left: 1px solid var(--border)
    }

    .seg button.active {
      background: rgba(91, 140, 255, .16);
      color: #eaf0ff
    }

    .section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      border-top: 1px dashed var(--border);
      margin-top: 12px;
      padding-top: 12px
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 170px;
      flex: 1 1 170px;
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px
    }

    .field label {
      font-size: 12px;
      color: var(--muted)
    }

    .field input[type="number"],
    .field input[type="time"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0d1430;
      color: var(--text);
      outline: none
    }

    /* Switch */
    .switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer
    }

    .switch input {
      display: none
    }

    .switch .knob {
      width: 48px;
      height: 28px;
      border-radius: 999px;
      position: relative;
      background: #2b345b;
      border: 1px solid var(--border);
      transition: background .2s
    }

    .switch .knob::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #c6d3ff;
      transition: left .2s
    }

    .switch input:checked+.knob {
      background: #1e7b54;
      border-color: #299e70
    }

    .switch input:checked+.knob::after {
      left: 24px;
      background: #eafff6
    }

    /* Responsive spans on larger screens */
    @media (min-width: 900px) {
      .span-6 {
        grid-column: span 6
      }

      .span-4 {
        grid-column: span 4
      }

      .span-8 {
        grid-column: span 8
      }
    }

    /* Mobile tweaks */
    @media (max-width: 599px) {
      .seg {
        width: 100%
      }

      .seg button {
        flex: 1 1 33.3%
      }

      .controls {
        width: 100%;
        justify-content: space-between
      }

      .chips .kv {
        min-width: 46%;
        flex: 1 1 46%
      }
    }

    .footer {
      margin: 16px 0 10px;
      text-align: center;
      color: var(--muted);
      font-size: 12px
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #0e1534;
      color: #eaf0ff;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, .35);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .2s, transform .2s
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0)
    }

    /* Offline banner */
    .offline {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      z-index: 10;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #7a2d2d;
      background: #351618;
      color: #ffd5d5;
      font-size: 13px;
      display: none
    }

    .offline.show {
      display: block
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 12s3-5 9-5 9 5 9 5-3 5-9 5-9-5-9-5Z" stroke="#5b8cff" stroke-width="1.5" />
          <circle cx="12" cy="12" r="2.2" stroke="#5b8cff" stroke-width="1.5" />
        </svg>
        <h1>Smart Fish Tank</h1>
      </div>
      <div class="chip" id="conn">Connecting…</div>
    </header>

    <div class="grid">
      <!-- Live Sensors -->
      <section class="card span-6">
        <h2>Live Sensors</h2>
        <div class="chips" id="sensors">
          <div class="kv"><b>Temperature</b><span id="temp">—</span></div>
          <div class="kv"><b>Humidity</b><span id="hum">—</span></div>
          <div class="kv"><b>Ambient Light (ADC)</b><span id="ldr">—</span></div>
          <div class="kv"><b>Proximity</b><span id="prox">—</span></div>
          <div class="kv"><b>Last Update</b><span id="last">—</span></div>
        </div>
      </section>

      <!-- Actuators -->
      <section class="card span-6">
        <h2>Relays & Modes</h2>

        <div class="section">
          <div>
            <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Light</div>
            <div class="seg" role="tablist" aria-label="Light mode">
              <button class="mode-light" data-mode="auto" aria-pressed="false">Auto</button>
              <button class="mode-light" data-mode="manual" aria-pressed="false">Manual</button>
              <button class="mode-light" data-mode="off" aria-pressed="false">Off</button>
            </div>
          </div>
          <div class="controls">
            <button id="btnLightState" class="btn toggle" title="Manual ON/OFF (enabled in Manual mode)"
              aria-pressed="false">Light: OFF</button>
          </div>
        </div>

        <div class="section">
          <div>
            <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Pump</div>
            <div class="seg" role="tablist" aria-label="Pump mode">
              <button class="mode-pump" data-mode="auto" aria-pressed="false">Auto</button>
              <button class="mode-pump" data-mode="manual" aria-pressed="false">Manual</button>
              <button class="mode-pump" data-mode="off" aria-pressed="false">Off</button>
            </div>
          </div>
          <div class="controls">
            <button id="btnPumpState" class="btn toggle" title="Manual ON/OFF (enabled in Manual mode)"
              aria-pressed="false">Pump: OFF</button>
          </div>
        </div>
      </section>

      <!-- Feeding -->
      <section class="card span-4">
        <h2>Feeding</h2>
        <div class="chips">
          <div class="kv"><b>Last Feed</b><span id="lastFeed">—</span></div>
          <div class="kv"><b>Next Feed</b><span id="nextFeed">—</span></div>
        </div>

        <div class="section">
          <div class="controls">
            <label class="switch" title="Enable scheduled feeding">
              <input type="checkbox" id="feedingEnabled" />
              <span class="knob" aria-hidden="true"></span>
            </label>
            <span style="color:var(--muted);font-size:14px;">Enable scheduled feeding</span>
          </div>
          <button id="feedNow" class="btn primary">Feed Now</button>
        </div>

        <div class="section">
          <div class="field">
            <label for="time1">Feeding time 1</label>
            <input id="time1" type="time" value="08:00" />
          </div>
          <div class="field">
            <label for="time2">Feeding time 2</label>
            <input id="time2" type="time" value="20:00" />
          </div>
        </div>
      </section>

      <!-- Automation Rules -->
      <section class="card span-8">
        <h2>Automation & Thresholds</h2>

        <div class="section">
          <div class="controls">
            <label class="switch">
              <input type="checkbox" id="presenceRule" />
              <span class="knob"></span>
            </label>
            <span style="color:var(--muted);font-size:14px;">Presence rule (≤ proximity)</span>
          </div>

          <div class="controls">
            <label class="switch">
              <input type="checkbox" id="lowLightRule" />
              <span class="knob"></span>
            </label>
            <span style="color:var(--muted);font-size:14px;">Low-light rule (light ≤ ADC)</span>
          </div>
        </div>

        <div class="section">
          <div class="field">
            <label for="proxThresh">Proximity threshold (cm)</label>
            <input id="proxThresh" type="number" min="1" max="400" step="1" value="20" />
          </div>
          <div class="field">
            <label for="lightThresh">Low-light threshold (ADC)</label>
            <input id="lightThresh" type="number" min="0" max="4095" step="1" value="1700" />
          </div>
        </div>

        <div class="section">
          <div class="controls">
            <label class="switch">
              <input type="checkbox" id="hourlyPumpEnabled" />
              <span class="knob"></span>
            </label>
            <span style="color:var(--muted);font-size:14px;">Hourly pump</span>
          </div>
          <div class="field">
            <label for="hourlyPumpSeconds">Hourly pump runtime (seconds)</label>
            <input id="hourlyPumpSeconds" type="number" min="5" max="300" step="5" value="25" />
          </div>
        </div>
      </section>
    </div>

    <div class="footer">Status: <span id="authState">auth…</span></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="offline" class="offline">You’re offline. Changes will sync when connected.</div>

  <script>
    // ---- Firebase config (left unchanged; matches your firmware) ----
    const firebaseConfig = {
      apiKey: "AIzaSyCPokWLKrM-JbJgQL0vVDccdR-qrmAHQ_Q",
      authDomain: "fishtank-system.firebaseapp.com",
      databaseURL: "https://fishtank-system-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fishtank-system",
      storageBucket: "fishtank-system.firebasestorage.app",
      messagingSenderId: "333858962529",
      appId: "1:333858962529:web:87ea50878e00d4bdd8be20",
      measurementId: "G-67L85BD3S8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ---- Helpers ----
    const el = id => document.getElementById(id);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const conn = el('conn');
    const authState = el('authState');
    const toast = el('toast');
    const offline = el('offline');

    function showToast(msg, ms = 1800) {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), ms);
    }
    function setConn(text, good = false) {
      conn.textContent = text;
      conn.style.background = good ? 'rgba(17,181,127,.18)' : 'var(--chip)';
      conn.style.borderColor = good ? 'rgba(17,181,127,.6)' : 'var(--chip-border)';
      conn.style.color = good ? '#cffff1' : 'var(--muted)';
    }
    function fmtTime(ts) {
      if (!ts) return '—';
      const d = new Date(ts * 1000);
      return d.toLocaleString(undefined, { hour12: false });
    }
    function nextFeedFrom(settings) {
      if (!settings?.feedingEnabled) return '—';
      const times = [settings.feedTime1, settings.feedTime2].filter(Boolean);
      const now = new Date(); const candidates = [];
      for (const hhmm of times) {
        const [H, M] = (hhmm || '').split(':').map(v => parseInt(v || 0, 10));
        const today = new Date(now); today.setHours(H || 0, M || 0, 0, 0);
        const n = today > now ? today : new Date(today.getTime() + 86400000);
        candidates.push(n);
      }
      candidates.sort((a, b) => a - b);
      return candidates[0]?.toLocaleString(undefined, { hour12: false }) || '—';
    }
    function setSegActive(buttons, value) {
      buttons.forEach(b => {
        const active = b.dataset.mode === value;
        b.classList.toggle('active', active);
        b.setAttribute('aria-pressed', String(active));
      });
    }
    function setManualBtnVisual(btn, isOn, enabled, label) {
      btn.textContent = `${label}: ${isOn ? 'ON' : 'OFF'}`;
      btn.classList.remove('active', 'off');
      btn.classList.add(isOn ? 'active' : 'off');
      btn.disabled = !enabled;
      btn.style.opacity = enabled ? 1 : .6;
      btn.setAttribute('aria-pressed', String(isOn));
      btn.title = enabled ? 'Toggle' : 'Switch to Manual mode to enable';
    }
    function dbUpdate(path, data) { return db.ref(path).update(data); }

    // ---- AUTH ----
    setConn('Connecting…');
    auth.onAuthStateChanged(user => {
      if (user) { authState.textContent = 'signed in (anonymous)'; setConn('Online', true); }
      else { authState.textContent = 'signing in…'; }
    });
    auth.signInAnonymously().catch(err => {
      console.error(err); showToast('Auth error: ' + err.message, 2600); setConn('Auth error');
    });

    // ---- Refs ----
    const temp = el('temp'), hum = el('hum'), ldr = el('ldr'), prox = el('prox'), last = el('last');
    const lastFeed = el('lastFeed'), nextFeed = el('nextFeed');

    const btnLightState = el('btnLightState'), btnPumpState = el('btnPumpState');
    const lightModeButtons = $$('.mode-light'), pumpModeButtons = $$('.mode-pump');

    const feedingEnabled = el('feedingEnabled'), feedNow = el('feedNow'), time1 = el('time1'), time2 = el('time2');

    const presenceRule = el('presenceRule'), lowLightRule = el('lowLightRule');
    const proxThresh = el('proxThresh'), lightThresh = el('lightThresh');
    const hourlyPumpEnabled = el('hourlyPumpEnabled'), hourlyPumpSeconds = el('hourlyPumpSeconds');

    // ---- Live sensors ----
    db.ref('/sensors').on('value', snap => {
      const s = snap.val() || {};
      temp.textContent = Number.isFinite(s.temperature_c) ? `${s.temperature_c.toFixed(1)} °C` : '—';
      hum.textContent = Number.isFinite(s.humidity_pct) ? `${s.humidity_pct.toFixed(0)} %` : '—';
      ldr.textContent = Number.isFinite(s.light_adc) ? s.light_adc : '—';
      prox.textContent = Number.isFinite(s.proximity_cm) ? `${s.proximity_cm} cm` : '—';
      last.textContent = s.last_update ? fmtTime(s.last_update) : '—';
    });

    // ---- States & modes ----
    let _lightMode = 'auto', _pumpMode = 'auto';
    db.ref('/states').on('value', snap => {
      const st = snap.val() || {};
      const light_on = !!st.light_on;
      const pump_on = !!st.pump_on;
      _lightMode = st.light_mode || _lightMode;
      _pumpMode = st.pump_mode || _pumpMode;

      setSegActive(lightModeButtons, _lightMode);
      setSegActive(pumpModeButtons, _pumpMode);
      setManualBtnVisual(btnLightState, light_on, _lightMode === 'manual', 'Light');
      setManualBtnVisual(btnPumpState, pump_on, _pumpMode === 'manual', 'Pump');
    });

    // ---- Meta (feeding) ----
    db.ref('/meta').on('value', snap => {
      const m = snap.val() || {};
      lastFeed.textContent = m.last_feed_time ? fmtTime(m.last_feed_time) : '—';
    });

    // ---- Settings (fill UI) ----
    let _settings = null;
    db.ref('/settings').on('value', snap => {
      const s = snap.val() || {};
      _settings = {
        presenceRuleEnabled: !!s.presence_rule,
        lowLightRuleEnabled: !!s.low_light_rule,
        hourlyPump: {
          enabled: !!(s.hourly_pump && s.hourly_pump.enabled),
          seconds: Number(s.hourly_pump && s.hourly_pump.seconds) || 25
        },
        proximity_cm: Number(s.thresholds && s.thresholds.proximity_cm) || 20,
        low_light_adc: Number(s.thresholds && s.thresholds.low_light_adc) || 1700,
        feedingEnabled: !!(s.feeding && s.feeding.enabled),
        feedTime1: (s.feeding && s.feeding.time1) || '08:00',
        feedTime2: (s.feeding && s.feeding.time2) || '20:00'
      };

      presenceRule.checked = _settings.presenceRuleEnabled;
      lowLightRule.checked = _settings.lowLightRuleEnabled;
      proxThresh.value = _settings.proximity_cm;
      lightThresh.value = _settings.low_light_adc;

      hourlyPumpEnabled.checked = _settings.hourlyPump.enabled;
      hourlyPumpSeconds.value = _settings.hourlyPump.seconds;

      feedingEnabled.checked = _settings.feedingEnabled;
      time1.value = _settings.feedTime1;
      time2.value = _settings.feedTime2;

      nextFeed.textContent = nextFeedFrom(_settings);
    });

    // ---- Writes: modes ----
    function setMode(kind, mode) {
      const key = kind === 'light' ? 'light_mode' : 'pump_mode';
      dbUpdate('/commands', { [key]: mode })
        .then(() => showToast(`${kind} → ${mode.toUpperCase()}`))
        .catch(err => showToast(err.message));
    }
    lightModeButtons.forEach(btn => btn.addEventListener('click', () => setMode('light', btn.dataset.mode)));
    pumpModeButtons.forEach(btn => btn.addEventListener('click', () => setMode('pump', btn.dataset.mode)));

    // ---- Writes: manual states ----
    btnLightState.addEventListener('click', () => {
      if (_lightMode !== 'manual') return;
      const isOn = btnLightState.classList.contains('active');
      dbUpdate('/commands', { light_manual_state: !isOn }).catch(err => showToast(err.message));
    });
    btnPumpState.addEventListener('click', () => {
      if (_pumpMode !== 'manual') return;
      const isOn = btnPumpState.classList.contains('active');
      dbUpdate('/commands', { pump_manual_state: !isOn }).catch(err => showToast(err.message));
    });

    // ---- Writes: Feed now ----
    feedNow.addEventListener('click', () => {
      feedNow.disabled = true;
      dbUpdate('/commands', { feed_now: true })
        .then(() => showToast('Feeding…'))
        .finally(() => setTimeout(() => feedNow.disabled = false, 800));
    });

    // ---- Writes: settings (debounced) ----
    let writeTimer;
    function scheduleWrite() { clearTimeout(writeTimer); writeTimer = setTimeout(writeSettings, 280); }
    function writeSettings() {
      const updates = {
        presence_rule: presenceRule.checked,
        low_light_rule: lowLightRule.checked,
        hourly_pump: { enabled: hourlyPumpEnabled.checked, seconds: Number(hourlyPumpSeconds.value || 25) },
        thresholds: { proximity_cm: Number(proxThresh.value || 20), low_light_adc: Number(lightThresh.value || 1700) },
        feeding: { enabled: feedingEnabled.checked, time1: time1.value || '08:00', time2: time2.value || '20:00' }
      };
      db.ref('/settings').set(updates).then(() => showToast('Settings saved')).catch(err => showToast(err.message));
    }
    [presenceRule, lowLightRule, hourlyPumpEnabled, hourlyPumpSeconds, proxThresh, lightThresh, feedingEnabled, time1, time2]
      .forEach(ctrl => {
        ctrl.addEventListener('change', scheduleWrite);
        ctrl.addEventListener('input', scheduleWrite);
      });

    // ---- Connection/Offline status ----
    db.ref(".info/connected").on("value", snap => {
      const ok = !!snap.val();
      setConn(ok ? 'Online' : 'Offline', ok);
      offline.classList.toggle('show', !ok);
    });
  </script>
</body>

</html>